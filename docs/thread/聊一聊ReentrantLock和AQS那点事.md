## å‰è¨€

ç”·ç”Ÿé­…åŠ›æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œ**æ˜¯æœ‰å‹‡æ°”é¢å¯¹å¤±è´¥**ï¼›è€Œç”Ÿæ´»çš„ç¾å¥½ä¹‹å¤„ï¼Œ**æ°æ°åœ¨äºå®ƒçš„ä¸ç¡®å®šæ€§**

AbstractQueuedSynchronizerï¼ˆAQSï¼‰æ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­ç»•ä¸è¿‡å»çš„ä¸€é“åï¼ŒJUC å¹¶å‘åŒ…ä¸‹çš„ Lockã€Semaphoreã€ReentrantLock ç­‰éƒ½æ˜¯åŸºäº AQS å®ç°çš„ã€‚AQS æ˜¯ä¸€ä¸ªæŠ½è±¡çš„åŒæ­¥æ¡†æ¶ï¼Œæä¾›äº†åŸå­æ€§ç®¡ç†åŒæ­¥çŠ¶æ€ï¼ŒåŸºäºé˜»å¡é˜Ÿåˆ—æ¨¡å‹å®ç°é˜»å¡å’Œå”¤é†’ç­‰å¾…çº¿ç¨‹çš„åŠŸèƒ½

æ–‡ç« ä» ReentrantLock åŠ é”ã€è§£é”åº”ç”¨ API å…¥æ‰‹ï¼Œé€æ­¥è®²è§£ AQS å¯¹åº”æºç ä»¥åŠç›¸å…³éšå«æµç¨‹

åˆ—å‡ºæœ¬ç¯‡æ–‡ç« å¤§çº²ä»¥åŠç›¸å…³çŸ¥è¯†ç‚¹ï¼Œæ–¹ä¾¿å¤§å®¶æ›´å¥½çš„ç†è§£

![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201115144318438.png)



## ä»€ä¹ˆæ˜¯ ReentrantLock

ReentrantLock ç¿»è¯‘ä¸º **å¯é‡å…¥é”**ï¼ŒæŒ‡çš„æ˜¯ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿå¯¹ **ä¸´ç•ŒåŒºå…±äº«èµ„æºè¿›è¡Œé‡å¤åŠ é”**

ç¡®ä¿çº¿ç¨‹å®‰å…¨æœ€å¸¸è§çš„åšæ³•æ˜¯åˆ©ç”¨é”æœºåˆ¶ï¼ˆLockã€sychronizedï¼‰æ¥å¯¹ **å…±äº«æ•°æ®åšäº’æ–¥åŒæ­¥**ï¼Œè¿™æ ·åœ¨åŒä¸€ä¸ªæ—¶åˆ»ï¼Œåªæœ‰ **ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡ŒæŸä¸ªæ–¹æ³•æˆ–è€…æŸä¸ªä»£ç å—**ï¼Œé‚£ä¹ˆæ“ä½œå¿…ç„¶æ˜¯ **åŸå­æ€§çš„ï¼Œçº¿ç¨‹å®‰å…¨çš„**

è¿™é‡Œå°±æœ‰ä¸ªç–‘é—®ï¼Œå› ä¸º JDK ä¸­å…³é”®å­— **synchronized** ä¹Ÿèƒ½åŒæ—¶æ”¯æŒåŸå­æ€§ä»¥åŠçº¿ç¨‹å®‰å…¨



**æœ‰äº† synchronized å…³é”®å­—åä¸ºä»€ä¹ˆè¿˜éœ€è¦ ReentrantLock?**



ä¸ºäº†å¤§å®¶æ›´å¥½çš„æŒæ¡ ReentrantLock æºç ï¼Œè¿™é‡Œåˆ—å‡ºä¸¤ç§é”ä¹‹é—´çš„åŒºåˆ«

|                |   Synchronized   |         ReentrantLock          |
| :------------: | :--------------: | :----------------------------: |
|   é”å®ç°æœºåˆ¶   | å¯¹è±¡å¤´ç›‘è§†å™¨æ¨¡å¼ |            ä¾èµ– AQS            |
|     çµæ´»æ€§     |      ä¸çµæ´»      | æ”¯æŒå“åº”ä¸­æ–­ã€è¶…æ—¶ã€å°è¯•è·å–é” |
|   é‡Šæ”¾é”å½¢å¼   |    è‡ªåŠ¨é‡Šæ”¾é”    |       æ˜¾ç¤ºè°ƒç”¨ unlock()        |
|   æ”¯æŒé”ç±»å‹   |     éå…¬å¹³é”     |       å…¬å¹³é” & éå…¬å¹³é”        |
|    æ¡ä»¶é˜Ÿåˆ—    |    å•æ¡ä»¶é˜Ÿåˆ—    |          å¤šä¸ªæ¡ä»¶é˜Ÿåˆ—          |
| æ˜¯å¦æ”¯æŒå¯é‡å…¥ |       æ”¯æŒ       |              æ”¯æŒ              |



<br/>

é€šè¿‡ä»¥ä¸Šå…­ä¸ªç»´åº¦æ¯”å¯¹ï¼Œå¯ä»¥çœ‹å‡º ReentrantLock æ˜¯è¦æ¯” synchronized **çµæ´»ä»¥åŠæ”¯æŒåŠŸèƒ½æ›´ä¸°å¯Œ**



## ä»€ä¹ˆæ˜¯ AQS

AQSï¼ˆ AbstractQueuedSynchronizer ï¼‰æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºé”å’ŒåŒæ­¥å™¨çš„æŠ½è±¡æ¡†æ¶ï¼Œåªéœ€è¦ç»§æ‰¿ AQS å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°æˆ‘ä»¬è‡ªå®šä¹‰çš„å¤šçº¿ç¨‹åŒæ­¥å™¨ã€é”



![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201114220450839.png)



å¦‚å›¾æ‰€ç¤ºï¼Œåœ¨ **java.util.concurrent** åŒ…ä¸‹ç›¸å…³é”ã€åŒæ­¥å™¨ï¼ˆå¸¸ç”¨çš„æœ‰ ReentrantLockã€ ReadWriteLockã€CountDownLatch...ï¼‰éƒ½æ˜¯åŸºäº AQS æ¥å®ç°



**AQS æ˜¯å…¸å‹çš„æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼**ï¼Œçˆ¶ç±»ï¼ˆAQSï¼‰å®šä¹‰å¥½éª¨æ¶å’Œå†…éƒ¨æ“ä½œç»†èŠ‚ï¼Œå…·ä½“è§„åˆ™ç”±å­ç±»å»å®ç°







### AQS æ ¸å¿ƒåŸç†

å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºæœªè¢«å ç”¨ï¼Œå°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºç‹¬å çº¿ç¨‹ï¼Œå¹¶å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€

AQS ä½¿ç”¨ä¸€ä¸ª Volatile ä¿®é¥°çš„ int ç±»å‹çš„æˆå‘˜å˜é‡ State æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œä¿®æ”¹åŒæ­¥çŠ¶æ€æˆåŠŸå³ä¸ºè·å¾—é”

Volatile ä¿è¯äº†å˜é‡åœ¨å¤šçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼Œä¿®æ”¹ State å€¼æ—¶é€šè¿‡ CAS æœºåˆ¶æ¥ä¿è¯ä¿®æ”¹çš„åŸå­æ€§

å¦‚æœå…±äº«èµ„æºè¢«å ç”¨ï¼Œéœ€è¦ä¸€å®šçš„é˜»å¡ç­‰å¾…å”¤é†’æœºåˆ¶æ¥ä¿è¯é”çš„åˆ†é…ï¼ŒAQS ä¸­ä¼šå°†ç«äº‰å…±äº«èµ„æºå¤±è´¥çš„çº¿ç¨‹æ·»åŠ åˆ°ä¸€ä¸ªå˜ä½“çš„ CLH é˜Ÿåˆ—ä¸­



![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201115014812244.png)



å…³äºæ”¯æ’‘ AQS ç‰¹æ€§çš„é‡è¦æ–¹æ³•åŠå±æ€§å¦‚ä¸‹ï¼š

```java
public abstract class AbstractQueuedSynchronizer 
  extends AbstractOwnableSynchronizer implements java.io.Serializable {
  	// CLH å˜ä½“é˜Ÿåˆ—å¤´ã€å°¾èŠ‚ç‚¹
    private transient volatile Node head;
  	private transient volatile Node tail;
  	// AQS åŒæ­¥çŠ¶æ€
   	private volatile int state;
  	// CAS æ–¹å¼æ›´æ–° state
  	protected final boolean compareAndSetState(int expect, int update) {
        return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
    }
}
```



### CLH é˜Ÿåˆ—

æ—¢ç„¶æ˜¯ AQS ä¸­ä½¿ç”¨çš„æ˜¯ CLH å˜ä½“é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹ CLH é˜Ÿåˆ—æ˜¯ä»€ä¹ˆ

CLHï¼šCraigã€Landin and Hagersten é˜Ÿåˆ—ï¼Œæ˜¯ **å•å‘é“¾è¡¨å®ç°çš„é˜Ÿåˆ—**ã€‚ç”³è¯·çº¿ç¨‹åªåœ¨æœ¬åœ°å˜é‡ä¸Šè‡ªæ—‹ï¼Œ**å®ƒä¸æ–­è½®è¯¢å‰é©±çš„çŠ¶æ€**ï¼Œå¦‚æœå‘ç° **å‰é©±èŠ‚ç‚¹é‡Šæ”¾äº†é”å°±ç»“æŸè‡ªæ—‹**

![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201107234158422.png)

é€šè¿‡å¯¹ CLH é˜Ÿåˆ—çš„è¯´æ˜ï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®º

1. CLH é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œä¿æŒ FIFO å…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ç‰¹æ€§
2. é€šè¿‡ tail å°¾èŠ‚ç‚¹ï¼ˆåŸå­å¼•ç”¨ï¼‰æ¥æ„å»ºé˜Ÿåˆ—ï¼Œæ€»æ˜¯æŒ‡å‘æœ€åä¸€ä¸ªèŠ‚ç‚¹
3. æœªè·å¾—é”èŠ‚ç‚¹ä¼šè¿›è¡Œè‡ªæ—‹ï¼Œè€Œä¸æ˜¯åˆ‡æ¢çº¿ç¨‹çŠ¶æ€
4. å¹¶å‘é«˜æ—¶æ€§èƒ½è¾ƒå·®ï¼Œå› ä¸ºæœªè·å¾—é”èŠ‚ç‚¹ä¸æ–­è½®è®­å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€æ¥æŸ¥çœ‹æ˜¯å¦è·å¾—é”



AQS ä¸­çš„é˜Ÿåˆ—æ˜¯ CLH å˜ä½“çš„è™šæ‹ŸåŒå‘é˜Ÿåˆ—ï¼Œé€šè¿‡å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ªèŠ‚ç‚¹æ¥å®ç°é”çš„åˆ†é…

![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201114161720040.png)

ç›¸æ¯”äº CLH é˜Ÿåˆ—è€Œè¨€ï¼ŒAQS ä¸­çš„ CLH å˜ä½“ç­‰å¾…é˜Ÿåˆ—æ‹¥æœ‰ä»¥ä¸‹ç‰¹æ€§

1. AQS ä¸­é˜Ÿåˆ—æ˜¯ä¸ªåŒå‘é“¾è¡¨ï¼Œä¹Ÿæ˜¯ FIFO å…ˆè¿›å…ˆå‡ºçš„ç‰¹æ€§
2. é€šè¿‡ Headã€Tail å¤´å°¾ä¸¤ä¸ªèŠ‚ç‚¹æ¥ç»„æˆé˜Ÿåˆ—ç»“æ„ï¼Œé€šè¿‡ volatile ä¿®é¥°ä¿è¯å¯è§æ€§
3. Head æŒ‡å‘èŠ‚ç‚¹ä¸ºå·²è·å¾—é”çš„èŠ‚ç‚¹ï¼Œæ˜¯ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹æœ¬èº«ä¸æŒæœ‰å…·ä½“çº¿ç¨‹
4. è·å–ä¸åˆ°åŒæ­¥çŠ¶æ€ï¼Œä¼šå°†èŠ‚ç‚¹è¿›è¡Œè‡ªæ—‹è·å–é”ï¼Œè‡ªæ—‹ä¸€å®šæ¬¡æ•°å¤±è´¥åä¼šå°†çº¿ç¨‹é˜»å¡ï¼Œç›¸å¯¹äº CLH é˜Ÿåˆ—æ€§èƒ½è¾ƒå¥½



### è®¤è¯† AOS

æŠ½è±¡ç±» AQS åŒæ ·ç»§æ‰¿è‡ªæŠ½è±¡ç±» AOSï¼ˆAbstractOwnableSynchronizerï¼‰

AOS å†…éƒ¨åªæœ‰ä¸€ä¸ª Thread ç±»å‹çš„å˜é‡ï¼Œæä¾›äº†è·å–å’Œè®¾ç½®å½“å‰ç‹¬å é”çº¿ç¨‹çš„æ–¹æ³•

ä¸»è¦ä½œç”¨æ˜¯ **è®°å½•å½“å‰å ç”¨ç‹¬å é”ï¼ˆäº’æ–¥é”ï¼‰çš„çº¿ç¨‹å®ä¾‹**

```java
public abstract class AbstractOwnableSynchronizer implements java.io.Serializable {
    // ç‹¬å çº¿ç¨‹ï¼ˆä¸å‚ä¸åºåˆ—åŒ–ï¼‰
    private transient Thread exclusiveOwnerThread;
    // è®¾ç½®å½“å‰ç‹¬å çš„çº¿ç¨‹
    protected final void setExclusiveOwnerThread(Thread thread) {
        exclusiveOwnerThread = thread;
    }
    // è¿”å›å½“å‰ç‹¬å çš„çº¿ç¨‹
    protected final Thread getExclusiveOwnerThread() {
        return exclusiveOwnerThread;
    }
}
```

### ä¸ºä»€ä¹ˆè¦æŒæ¡ AQS

å¦‚ä½•èƒ½å¤Ÿä½“ç°ç¨‹åºå‘˜çš„æ°´å¹³ï¼Œé‚£å°±æ˜¯æŒæ¡å¤§å¤šæ•°äººæ‰€ä¸æŒæ¡çš„æŠ€æœ¯ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆé¢è¯•æ—¶ AQS é«˜é¢‘å‡ºç°çš„åŸå› ï¼Œå› ä¸ºå®ƒä¸ç®€å•



æœ€åˆæ¥è§¦ ReentrantLock ä»¥åŠ AQS çš„æ—¶å€™ï¼Œçœ‹åˆ°æºç å°±æ˜¯ä¸€å¤´é›¾æ°´ï¼ŒDebug è·Ÿç€è·Ÿç€å°± **è¿·å¤±äº†è‡ªå·±**ï¼Œç›¸ä¿¡è¿™ä¹Ÿæ˜¯å¤§å¤šæ•°äººçš„ååº”

æ­£æ˜¯å› ä¸ºç»å†è¿‡ï¼Œæ‰€ä»¥æ‰èƒ½ä»å°ç™½çš„å¿ƒç†ä¸Šå‡ºå‘ï¼ŒæŠŠå…¶ä¸­çš„çŸ¥è¯†ç‚¹èƒ½å¤Ÿå°½æ•°æ¢³ç†



ä½œè€…å†™çš„å¾ˆç”¨å¿ƒï¼Œçœ‹è¿‡è¿™ç¯‡æ–‡ç« çš„å°ä¼™ä¼´ï¼Œä¸æ•¢ä¿è¯ç™¾åˆ†ç™¾ç†è§£ AQS å’Œ ReentrantLock çš„åŸç†ï¼Œä½†æ˜¯ä¸€å®šä¼šæœ‰æ‰€æ”¶è·



## ç‹¬å åŠ é”æºç è§£æ



### ä»€ä¹ˆæ˜¯ç‹¬å é”

ç‹¬å é”ä¹Ÿå«æ’å®ƒé”ï¼Œæ˜¯æŒ‡è¯¥é”ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰ï¼Œå¦‚æœåˆ«çš„çº¿ç¨‹æƒ³è¦è·å–é”ï¼Œåªæœ‰ç­‰åˆ°æŒæœ‰é”çº¿ç¨‹é‡Šæ”¾

è·å¾—æ’å®ƒé”çš„çº¿ç¨‹å³èƒ½è¯»æ•°æ®åˆèƒ½ä¿®æ”¹æ•°æ®ï¼Œä¸ä¹‹å¯¹ç«‹çš„å°±æ˜¯å…±äº«é”

å…±äº«é”æ˜¯æŒ‡è¯¥é”å¯è¢«å¤šä¸ªçº¿ç¨‹æ‰€æŒæœ‰ã€‚å¦‚æœçº¿ç¨‹Tå¯¹æ•°æ®AåŠ ä¸Šå…±äº«é”åï¼Œåˆ™å…¶ä»–çº¿ç¨‹åªèƒ½å¯¹Aå†åŠ å…±äº«é”ï¼Œä¸èƒ½åŠ æ’å®ƒé”

è·å¾—å…±äº«é”çš„çº¿ç¨‹åªèƒ½è¯»æ•°æ®ï¼Œä¸èƒ½ä¿®æ”¹æ•°æ®



### ç‹¬å é”åŠ é”

ReentrantLock å°±æ˜¯ç‹¬å é”çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œæ¥ä¸‹æ¥çœ‹ä»£ç ä¸­å¦‚ä½•ä½¿ç”¨ ReentrantLock å®Œæˆç‹¬å å¼åŠ é”ä¸šåŠ¡é€»è¾‘

```java
public static void main(String[] args) {
    // åˆ›å»ºéå…¬å¹³é”
    ReentrantLock lock = new ReentrantLock();
    // è·å–é”æ“ä½œ
    lock.lock();
    try {
        // æ‰§è¡Œä»£ç é€»è¾‘
    } catch (Exception ex) {
        // ...
    } finally {
        // è§£é”æ“ä½œ
        lock.unlock();
    }
}
```



new ReentrantLock() æ„é€ å‡½æ•°é»˜è®¤åˆ›å»ºçš„æ˜¯éå…¬å¹³é” NonfairSync

```java
public ReentrantLock() {
    sync = new NonfairSync();
}
```





åŒæ—¶ä¹Ÿå¯ä»¥åœ¨åˆ›å»ºé”æ„é€ å‡½æ•°ä¸­ä¼ å…¥å…·ä½“å‚æ•°åˆ›å»ºå…¬å¹³é” FairSync

```java
ReentrantLock lock = new ReentrantLock(true);
--- ReentrantLock
// true ä»£è¡¨å…¬å¹³é”ï¼Œfalse ä»£è¡¨éå…¬å¹³é”
public ReentrantLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
}
```



FairSyncã€NonfairSync ä»£è¡¨å…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œä¸¤è€…éƒ½æ˜¯ ReentrantLock é™æ€å†…éƒ¨ç±»ï¼Œåªä¸è¿‡å®ç°ä¸åŒé”è¯­ä¹‰

**å…¬å¹³é” FairSync**

1. å…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”ï¼Œçº¿ç¨‹ç›´æ¥è¿›å…¥é˜Ÿåˆ—ä¸­æ’é˜Ÿï¼Œé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰èƒ½è·å¾—é”
2. å…¬å¹³é”çš„ä¼˜ç‚¹æ˜¯ç­‰å¾…é”çš„çº¿ç¨‹ä¸ä¼šé¥¿æ­»ã€‚ç¼ºç‚¹æ˜¯æ•´ä½“ååæ•ˆç‡ç›¸å¯¹éå…¬å¹³é”è¦ä½ï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­é™¤ç¬¬ä¸€ä¸ªçº¿ç¨‹ä»¥å¤–çš„æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šé˜»å¡ï¼ŒCPU å”¤é†’é˜»å¡çº¿ç¨‹çš„å¼€é”€æ¯”éå…¬å¹³é”å¤§

**éå…¬å¹³é” NonfairSync**

1. éå…¬å¹³é”æ˜¯å¤šä¸ªçº¿ç¨‹åŠ é”æ—¶ç›´æ¥å°è¯•è·å–é”ï¼Œè·å–ä¸åˆ°æ‰ä¼šåˆ°ç­‰å¾…é˜Ÿåˆ—çš„é˜Ÿå°¾ç­‰å¾…ã€‚ä½†å¦‚æœæ­¤æ—¶é”åˆšå¥½å¯ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å¯ä»¥æ— éœ€é˜»å¡ç›´æ¥è·å–åˆ°é”
2. éå…¬å¹³é”çš„ä¼˜ç‚¹æ˜¯å¯ä»¥å‡å°‘å”¤èµ·çº¿ç¨‹çš„å¼€é”€ï¼Œæ•´ä½“çš„ååæ•ˆç‡é«˜ï¼Œå› ä¸ºçº¿ç¨‹æœ‰å‡ ç‡ä¸é˜»å¡ç›´æ¥è·å¾—é”ï¼ŒCPU ä¸å¿…å”¤é†’æ‰€æœ‰çº¿ç¨‹ã€‚ç¼ºç‚¹æ˜¯å¤„äºç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹å¯èƒ½ä¼šé¥¿æ­»ï¼Œæˆ–è€…ç­‰å¾ˆä¹…æ‰ä¼šè·å¾—é”



ä¸¤è€…çš„éƒ½ç»§æ‰¿è‡ª ReentrantLock é™æ€æŠ½è±¡å†…éƒ¨ç±» Syncï¼Œ**Sync ç±»ç»§æ‰¿è‡ª AQS**ï¼Œè¿™é‡Œå°±æœ‰ä¸ªç–‘é—®

è¿™äº›é”éƒ½æ²¡æœ‰ç›´æ¥ç»§æ‰¿ AQSï¼Œè€Œæ˜¯å®šä¹‰äº†ä¸€ä¸ª **Sync ç±»å»ç»§æ‰¿ AQS**ï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·å‘¢ï¼Ÿ

å› ä¸º **é”é¢å‘çš„æ˜¯ä½¿ç”¨ç”¨æˆ·**ï¼Œ**åŒæ­¥å™¨é¢å‘çš„åˆ™æ˜¯çº¿ç¨‹æ§åˆ¶**ï¼Œé‚£ä¹ˆåœ¨é”çš„å®ç°ä¸­èšåˆåŒæ­¥å™¨è€Œä¸æ˜¯ç›´æ¥ç»§æ‰¿ AQS å°±å¯ä»¥å¾ˆå¥½çš„ **éš”ç¦»äºŒè€…æ‰€å…³æ³¨çš„äº‹æƒ…**

é€šè¿‡å¯¹ä¸åŒé”ç§ç±»çš„è®²è§£ä»¥åŠ ReentrantLock å†…éƒ¨ç»“æ„çš„è§£æï¼Œæ ¹æ®ä¸Šä¸‹çº§å…³ç³»ç»§æ‰¿å›¾ï¼ŒåŠ æ·±å…¶ç†è§£

![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201106104059148.png)

è¿™é‡Œä»¥éå…¬å¹³é”ä¸¾ä¾‹ï¼ŒæŸ¥çœ‹åŠ é”çš„å…·ä½“è¿‡ç¨‹ï¼Œè¯¦ç»†ä¿¡æ¯ä¸‹æ–‡ä¼šè¯¦ç»†è¯´æ˜

![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201117222132211.png)



çœ‹ä¸€ä¸‹éå…¬å¹³é”åŠ é”æ–¹æ³• lock å†…éƒ¨æ€ä¹ˆåšçš„

```java
ReentrantLock lock = new ReentrantLock();
lock.lock();
--- ReentrantLock
public void lock() {
    sync.lock();
}
--- Sync
abstract void lock();
```



**Sync#lock** ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œæœ€ç»ˆä¼šè°ƒç”¨å…¶å­ç±»éå…¬å¹³é”çš„æ–¹æ³• lock 

```java
final void lock() {
    if (compareAndSetState(0, 1))
        setExclusiveOwnerThread(Thread.currentThread());
    else
        acquire(1);
}
```



éå…¬å¹³åŠ é”æ–¹æ³•æœ‰ä¸¤ä¸ªé€»è¾‘

1. é€šè¿‡æ¯”è¾ƒå¹¶æ›¿æ¢ Stateï¼ˆåŒæ­¥çŠ¶æ€ï¼‰æˆåŠŸä¸å¦å†³å®šæ˜¯å¦è·å¾—é”ï¼Œè®¾ç½® State ä¸º 1è¡¨ç¤ºæˆåŠŸè·å–é”ï¼Œå¹¶å°†å½“å‰çº¿ç¨‹è®¾ç½®ä¸ºç‹¬å çº¿ç¨‹
2. ä¿®æ”¹ State å€¼å¤±è´¥åˆ™è¿›å…¥å°è¯•è·å–é”æµç¨‹ï¼Œacquire æ–¹æ³•ä¸º AQS æä¾›çš„æ–¹æ³•



compareAndSetState ä»¥ CAS æ¯”è¾ƒå¹¶æ›¿æ¢çš„æ–¹å¼å°† State å€¼è®¾ç½®ä¸º 1ï¼Œè¡¨ç¤ºåŒæ­¥çŠ¶æ€è¢«å ç”¨

```java
protected final boolean compareAndSetState(int expect, int update) {
    // See below for intrinsics setup to support this
    return unsafe.compareAndSwapInt(this, StateOffset, expect, update);
}
```



setExclusiveOwnerThread è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å é”æ‹¥æœ‰çº¿ç¨‹

```java
protected final void setExclusiveOwnerThread(Thread thread) {    exclusiveOwnerThread = thread;}
```



acquire å¯¹æ•´ä¸ª AQS åšåˆ°äº†æ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ï¼Œé€šè¿‡ tryAcquire æ¨¡ç‰ˆæ–¹æ³•è¿›è¡Œå°è¯•è·å–é”ï¼Œè·å–é”å¤±è´¥åŒ…è£…å½“å‰çº¿ç¨‹ä¸º Node èŠ‚ç‚¹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—æ’é˜Ÿ

```java
public final void acquire(int arg) {    if (!tryAcquire(arg) &&            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))        selfInterrupt();}
```



tryAcquire æ˜¯ AQS ä¸­æŠ½è±¡æ¨¡ç‰ˆæ–¹æ³•ï¼Œä½†æ˜¯å†…éƒ¨ä¼šæœ‰é»˜è®¤å®ç°ï¼Œè™½ç„¶é»˜è®¤çš„æ–¹æ³•å†…éƒ¨æŠ›å‡ºå¼‚å¸¸ï¼Œ**ä¸ºä»€ä¹ˆä¸ç›´æ¥å®šä¹‰ä¸ºæŠ½è±¡æ–¹æ³•å‘¢?**

å› ä¸º AQS ä¸åªæ˜¯å¯¹ç‹¬å é”å®ç°äº†æŠ½è±¡ï¼ŒåŒæ—¶è¿˜åŒ…æ‹¬å…±äº«é”ï¼›ä¸åŒé”å®šä¹‰äº†ä¸åŒç±»åˆ«çš„æ–¹æ³•ï¼Œå…±äº«é”å°±ä¸éœ€è¦ tryAcquireï¼Œå¦‚æœå®šä¹‰ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œç»§æ‰¿ AQS å­ç±»éƒ½éœ€è¦å®ç°è¯¥æ–¹æ³•

```java
protected boolean tryAcquire(int arg) {    throw new UnsupportedOperationException();}
```



NonfairSync ç±»ä¸­æœ‰ tryAcquire é‡å†™æ–¹æ³•ï¼Œç»§ç»­æŸ¥çœ‹å…·ä½“å¦‚ä½•è¿›è¡Œéå…¬å¹³æ–¹å¼è·å–é”

```java
protected final boolean tryAcquire(int acquires) {    return nonfairTryAcquire(acquires);}final boolean nonfairTryAcquire(int acquires) {    final Thread current = Thread.currentThread();    int c = getState();  	// State ç­‰äº0è¡¨ç¤ºæ­¤æ—¶æ— é”    if (c == 0) {      	// å†æ¬¡ä½¿ç”¨CASå°è¯•è·å–é”, è¡¨ç°ä¸ºéå…¬å¹³é”ç‰¹æ€§        if (compareAndSetState(0, acquires)) {          	// è®¾ç½®çº¿ç¨‹ä¸ºç‹¬å é”çº¿ç¨‹            setExclusiveOwnerThread(current);            return true;        }    // å¦‚æœå½“å‰çº¿ç¨‹ç­‰äºå·²è·å–é”çº¿ç¨‹, è¡¨ç°ä¸ºå¯é‡å…¥é”ç‰¹æ€§    } else if (current == getExclusiveOwnerThread()) {        int nextc = c + acquires;        if (nextc < 0) // overflow            throw new Error("Maximum lock count exceeded");      	// è®¾ç½® State        setState(nextc);        return true;    }  	// å¦‚æœstateä¸ç­‰äº0å¹¶ä¸”ç‹¬å çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹, è¿”å› false    return false;}
```



ç”±äº tryAcquire åšäº†å–åï¼Œå¦‚æœè®¾ç½® state å¤±è´¥å¹¶ä¸”ç‹¬å é”çº¿ç¨‹ä¸æ˜¯è‡ªå·±æœ¬èº«è¿”å› falseï¼Œé€šè¿‡å–åä¼šè¿›å…¥æ¥ä¸‹æ¥çš„æµç¨‹

```java
public final void acquire(int arg) {    if (!tryAcquire(arg) &&            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))        selfInterrupt();}
```



### Node å…¥é˜Ÿæµç¨‹

å°è¯•è·å¾—é”å¤±è´¥ï¼Œæ¥ä¸‹æ¥ä¼šå°†çº¿ç¨‹ç»„è£…æˆä¸º Node è¿›è¡Œå…¥é˜Ÿæµç¨‹



Node æ˜¯ AQS ä¸­æœ€åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿæ˜¯ CLH å˜ä½“é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ï¼ŒNode æœ‰ **SHAREDï¼ˆå…±äº«ï¼‰ã€EXCLUSIVEï¼ˆç‹¬å ï¼‰** ä¸¤ç§æ¨¡å¼ï¼Œæ–‡ç« ä¸»è¦ä»‹ç» EXCLUSIVE æ¨¡å¼ï¼Œä¸ç›¸å…³çš„å±æ€§å’Œæ–¹æ³•ä¸äºˆä»‹ç»

ä¸‹é¢åˆ—å‡ºå…³äº Node EXCLUSIVE æ¨¡å¼çš„ä¸€äº›å…³é”®æ–¹æ³•ä»¥åŠçŠ¶æ€ä¿¡æ¯

| å…³é”®æ–¹æ³•ä¸å±æ€§ |              å¯¹åº”å«ä¹‰               |
| :------------: | :---------------------------------: |
|   waitStatus   |    å½“å‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­å¤„äºä»€ä¹ˆçŠ¶æ€     |
|     thread     |         è¡¨ç¤ºèŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹          |
|      prev      |  å‰é©±æŒ‡é’ˆï¼ŒæŒ‡å‘æœ¬èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹   |
|      next      |  åç»§æŒ‡é’ˆï¼ŒæŒ‡å‘æœ¬èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹   |
|  predecessor   | è¿”å›å‰é©±èŠ‚ç‚¹ï¼Œæ²¡æœ‰çš„è¯æŠ›å‡º NPE å¼‚å¸¸ |



Node ä¸­ç‹¬å é”ç›¸å…³çš„ waitStatus å±æ€§åˆ†åˆ«æœ‰ä»¥ä¸‹å‡ ç§çŠ¶æ€

|  å±æ€§å€¼   |                     å€¼å«ä¹‰                     |
| :-------: | :--------------------------------------------: |
|     0     |            Node è¢«åˆå§‹åŒ–åçš„é»˜è®¤å€¼             |
| CANCELLED |       å€¼ä¸º1ï¼Œç”±äºä¸­æ–­æˆ–è¶…æ—¶ï¼ŒèŠ‚ç‚¹è¢«å–æ¶ˆ        |
|  SIGNAL   |      å€¼ä¸º-1ï¼Œè¡¨ç¤ºèŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹å³å°†è¢«é˜»å¡      |
| CONDITION | å€¼ä¸º-2ï¼Œè¡¨ç¤ºèŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼ŒèŠ‚ç‚¹çº¿ç¨‹ç­‰å¾…å”¤é†’ |



ä»‹ç»å®Œ Node ç›¸å…³åŸºç¡€çŸ¥è¯†ï¼Œçœ‹ä¸€ä¸‹è¯·æ±‚é”çº¿ç¨‹å¦‚ä½•è¢«åŒ…è£…ä¸º Nodeï¼Œåˆæ˜¯å¦‚ä½•åˆå§‹åŒ–å…¥é˜Ÿçš„

```java
private Node addWaiter(Node mode) {    Node node = new Node(Thread.currentThread(), mode);    // è·å–ç­‰å¾…é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹    Node pred = tail;  	// å¦‚æœå°¾èŠ‚ç‚¹ä¸ä¸ºç©º, å°† node è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹, å¹¶å°†åŸå°¾èŠ‚ç‚¹ next æŒ‡å‘ æ–°çš„å°¾èŠ‚ç‚¹node    if (pred != null) {        node.prev = pred;        if (compareAndSetTail(pred, node)) {            pred.next = node;            return node;        }    }  	// å°¾éƒ¨ä¸ºç©ºï¼Œenq æ‰§è¡Œ    enq(node);    return node;}
```

pred ä¸ºé˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ï¼Œæ ¹æ®å°¾èŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºä¼šæ‰§è¡Œå¯¹åº”æµç¨‹

1. å°¾èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œè¯æ˜é˜Ÿåˆ—å·²è¢«åˆå§‹åŒ–ï¼Œé‚£ä¹ˆéœ€è¦å°†å¯¹åº”çš„ nodeï¼ˆå½“å‰çº¿ç¨‹ï¼‰è®¾ç½®ä¸ºæ–°çš„å°¾èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å…¥é˜Ÿæ“ä½œï¼›å°† node èŠ‚ç‚¹çš„å‰é©±æŒ‡é’ˆæŒ‡å‘ predï¼ˆå°¾èŠ‚ç‚¹ï¼‰ï¼Œå¹¶å°† node é€šè¿‡ CAS æ–¹å¼è®¾ç½®ä¸º AQS ç­‰å¾…é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ï¼Œæ›¿æ¢æˆåŠŸåå°†åŸæ¥çš„å°¾èŠ‚ç‚¹åç»§æŒ‡é’ˆæŒ‡å‘æ–°çš„å°¾èŠ‚ç‚¹
2. å°¾èŠ‚ç‚¹ä¸ºç©ºï¼Œè¯æ˜è¿˜æ²¡æœ‰åˆå§‹åŒ–é˜Ÿåˆ—ï¼Œæ‰§è¡Œ enq æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–é˜Ÿåˆ—



enq æ–¹æ³•æ‰§è¡Œåˆå§‹åŒ–é˜Ÿåˆ—æ“ä½œï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­è™šæ‹ŸåŒ–çš„å¤´èŠ‚ç‚¹ä¹Ÿæ˜¯åœ¨è¿™é‡Œäº§ç”Ÿ

```java
private Node enq(final Node node) {    for (; ; ) {        Node t = tail;        if (t == null) {          	// è™šæ‹ŸåŒ–ä¸€ä¸ªç©ºNode, å¹¶å°†headæŒ‡å‘ç©ºNode            if (compareAndSetHead(new Node()))              	// å°†å°¾èŠ‚ç‚¹ç­‰äºå¤´èŠ‚ç‚¹                tail = head;        } else {          	// nodeä¸Šä¸€æ¡æŒ‡å‘å°¾èŠ‚ç‚¹            node.prev = t;          	// è®¾ç½®nodeä¸ºå°¾èŠ‚ç‚¹            if (compareAndSetTail(t, node)) {              	// è®¾ç½®åŸå°¾èŠ‚ç‚¹çš„ä¸‹ä¸€æ¡æŒ‡å‘node                t.next = node;                return t;            }        }    }}
```

**æ‰§è¡Œ enq æ–¹æ³•çš„å‰æå°±æ˜¯é˜Ÿåˆ—å°¾èŠ‚ç‚¹ä¸ºç©ºï¼Œä¸ºä»€ä¹ˆè¿˜è¦å†åˆ¤æ–­å°¾èŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºï¼Ÿ**



å› ä¸º enq æ–¹æ³•ä¸­æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå¾ªç¯è¿‡ç¨‹ä¸­ t çš„å€¼æ˜¯ä¸å›ºå®šçš„ã€‚å‡å¦‚æ‰§è¡Œ enq æ–¹æ³•æ—¶é˜Ÿåˆ—ä¸ºç©ºï¼Œfor å¾ªç¯ä¼šæ‰§è¡Œä¸¤éä¸åŒçš„å¤„ç†é€»è¾‘

1. å°¾èŠ‚ç‚¹ä¸ºç©ºï¼Œè™šæ‹ŸåŒ–å‡ºä¸€ä¸ªæ–°çš„ Node å¤´èŠ‚ç‚¹ï¼Œè¿™æ—¶é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œä¸ºäº†ä¿è¯ AQS é˜Ÿåˆ—ç»“æ„çš„å®Œæ•´æ€§ï¼Œä¼šå°†å°¾èŠ‚ç‚¹æŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œç¬¬ä¸€éå¾ªç¯ç»“æŸ
2. ç¬¬äºŒéä¸æ»¡è¶³å°¾èŠ‚ç‚¹ä¸ºç©ºæ¡ä»¶ï¼Œæ‰§è¡Œ else è¯­å¥å—ï¼Œnode èŠ‚ç‚¹å‰é©±æŒ‡é’ˆæŒ‡å‘å°¾èŠ‚ç‚¹ï¼Œå¹¶å°† node é€šè¿‡ CAS è®¾ç½®ä¸ºæ–°çš„å°¾èŠ‚ç‚¹ï¼ŒæˆåŠŸåè®¾ç½®åŸå°¾èŠ‚ç‚¹çš„åç»§æŒ‡é’ˆæŒ‡å‘ nodeï¼Œè‡³æ­¤å…¥é˜ŸæˆåŠŸã€‚è¿”å›çš„ t æ— æ„ä¹‰ï¼Œåªæ˜¯ä¸ºäº†ç»ˆæ­¢æ­»å¾ªç¯



ç”»ä¸¤å¼ å›¾æ¥ç†è§£ enq æ–¹æ³•æ•´ä½“åˆå§‹åŒ– AQS é˜Ÿåˆ—æµç¨‹ï¼Œå‡è®¾T1ã€T2ä¸¤ä¸ªçº¿ç¨‹äº‰å–é”ï¼ŒT1æˆåŠŸè·å¾—é”ï¼ŒT2è¿›è¡Œå…¥é˜Ÿæ“ä½œ

1. T2è¿›è¡Œå…¥é˜Ÿæ“ä½œï¼Œå¾ªç¯ç¬¬ä¸€éï¼Œå°¾èŠ‚ç‚¹ä¸ºç©ºã€‚å¼€å§‹åˆå§‹åŒ–å¤´èŠ‚ç‚¹ï¼Œå¹¶å°†å°¾èŠ‚ç‚¹æŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œæœ€ç»ˆé˜Ÿåˆ—å½¢å¼æ˜¯è¿™æ ·çº¸æ»´

![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201114213221013.png)

2. å¾ªç¯ç¬¬äºŒéï¼Œéœ€è¦å°† node è®¾ç½®ä¸ºæ–°çš„å°¾èŠ‚ç‚¹ã€‚é€»è¾‘å¦‚ä¸‹ï¼šå°¾èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œè®¾ç½® node å‰é©±æŒ‡é’ˆæŒ‡å‘å°¾èŠ‚ç‚¹ï¼Œå¹¶å°† node è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹ï¼ŒåŸå°¾èŠ‚ç‚¹ next æŒ‡é’ˆæŒ‡å‘ node



addWaiter æ–¹æ³•å°±æ˜¯ä¸ºäº†è®© Node å…¥é˜Ÿï¼Œå¹¶ä¸”ç»´æŠ¤å‡ºä¸€ä¸ªåŒå‘é˜Ÿåˆ—æ¨¡å‹

å…¥é˜Ÿæ‰§è¡ŒæˆåŠŸåï¼Œä¼šåœ¨ acquireQueued å†æ¬¡å°è¯•ç«äº‰é”ï¼Œç«äº‰å¤±è´¥åä¼šå°†çº¿ç¨‹é˜»å¡

```java
public final void acquire(int arg) {    if (!tryAcquire(arg) &&            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))        selfInterrupt();}
```



acquireQueued æ–¹æ³•ä¼šå°è¯•è‡ªæ—‹è·å–é”ï¼Œè·å–å¤±è´¥å¯¹å½“å‰çº¿ç¨‹å®æ–½é˜»å¡æµç¨‹ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºäº†é¿å…æ— æ„ä¹‰çš„è‡ªæ—‹ï¼Œå¯¹æ¯” CLH é˜Ÿåˆ—æ€§èƒ½ä¼˜åŒ–çš„ä½“ç°

```java
final boolean acquireQueued(final Node node, int arg) {    boolean failed = true;    try {        boolean interrupted = false;        for (; ; ) {          	// è·å–nodeä¸Šä¸€ä¸ªèŠ‚ç‚¹            final Node p = node.predecessor();          	// å¦‚æœnodeä¸ºå¤´èŠ‚ç‚¹ & å°è¯•è·å–é”æˆåŠŸ            if (p == head && tryAcquire(arg)) {              	// æ­¤æ—¶å½“å‰nodeçº¿ç¨‹è·å–åˆ°äº†é”              	// å°†nodeè®¾ç½®ä¸ºæ–°çš„å¤´èŠ‚ç‚¹                setHead(node);              	// help GC                p.next = null;                failed = false;                return interrupted;            }            if (shouldParkAfterFailedAcquire(p, node) &&                    parkAndCheckInterrupt())                interrupted = true;        }    } finally {        if (failed)            cancelAcquire(node);    }}
```



é€šè¿‡ node.predecessor() è·å–èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œå‰é©±èŠ‚ç‚¹ä¸ºç©ºæŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸

```java
final Node predecessor() throws NullPointerException {    Node p = prev;    if (p == null)        throw new NullPointerException();    else        return p;}
```



è·å–åˆ°å‰é©±èŠ‚ç‚¹åè¿›è¡Œä¸¤æ­¥é€»è¾‘åˆ¤æ–­

1. åˆ¤æ–­å‰é©±èŠ‚ç‚¹ p æ˜¯å¦ä¸ºå¤´èŠ‚ç‚¹ï¼Œä¸º true è¿›è¡Œå°è¯•è·å–é”ï¼Œè·å–é”æˆåŠŸè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºæ–°çš„å¤´èŠ‚ç‚¹ï¼Œå¹¶å°†åŸå¤´èŠ‚ç‚¹çš„åé©±æŒ‡é’ˆè®¾ä¸ºç©º
2. å‰é©±èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹æˆ–è€…å°è¯•åŠ é”å¤±è´¥ï¼Œæ‰§è¡Œçº¿ç¨‹ä¼‘çœ é˜»å¡æ“ä½œ



å¦‚æœ node è·å¾—é”åï¼ŒsetHead å°†èŠ‚ç‚¹è®¾ç½®ä¸ºé˜Ÿåˆ—å¤´ï¼Œä»è€Œå®ç°å‡ºé˜Ÿæ•ˆæœï¼Œå‡ºäº GC çš„è€ƒè™‘ï¼Œæ¸…ç©ºæœªä½¿ç”¨çš„æ•°æ®

```java
private void setHead(Node node) {    head = node;    node.thread = null;    node.prev = null;}
```



shouldParkAfterFailedAcquire éœ€è¦é‡ç‚¹å…³æ³¨ä¸‹ï¼Œæµç¨‹ç›¸å¯¹æ¯”è¾ƒéš¾ç†è§£

```java
private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {    int ws = pred.waitStatus;    if (ws == Node.SIGNAL)        return true;    if (ws > 0) {        do {            node.prev = pred = pred.prev;        } while (pred.waitStatus > 0);        pred.next = node;    } else {        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);    }    return false;}
```



ws è¡¨ç¤ºä¸ºå½“å‰ç”³è¯·é”èŠ‚ç‚¹å‰é©±èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€ï¼Œä»£ç ä¸­åŒ…å«ä¸‰ä¸ªé€»è¾‘ï¼Œåˆ†åˆ«æ˜¯ï¼š

1. ws == Node.SIGNALï¼Œè¡¨ç¤ºéœ€è¦å°†ç”³è¯·é”èŠ‚ç‚¹è¿›è¡Œé˜»å¡
2. ws > 0ï¼Œè¡¨ç¤ºç­‰å¾…é˜Ÿåˆ—ä¸­åŒ…å«è¢«å–æ¶ˆèŠ‚ç‚¹ï¼Œéœ€è¦è°ƒæ•´é˜Ÿåˆ—
3. å¦‚æœ ws == Node.SIGNAL || ws >0 éƒ½ä¸º falseï¼Œä½¿ç”¨ CAS çš„æ–¹å¼å°†å‰é©±èŠ‚ç‚¹ç­‰å¾…çŠ¶æ€è®¾ç½®ä¸º Node.SIGNAL



> è®¾ç½®å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ç­‰å¾…çŠ¶æ€ä¸º Node.SIGNALï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹è·å–é”å¤±è´¥ï¼Œéœ€è¦è¿›è¡Œé˜»å¡æ“ä½œ



è¿˜æ˜¯é€šè¿‡å‡ å¼ å›¾æ¥ç†è§£æµç¨‹ï¼Œå‡è®¾æ­¤æ—¶ T1ã€T2 çº¿ç¨‹æ¥äº‰å¤ºé”

![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201114213609335.png)

T1 çº¿ç¨‹è·å¾—é”ï¼ŒT2 è¿›å…¥ AQS ç­‰å¾…é˜Ÿåˆ—æ’é˜Ÿï¼Œå¹¶é€šè¿‡ CAS å°† T2 èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ç­‰å¾…çŠ¶æ€ç½®ä¸º SIGNAL

![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201109140133492.png)

æ‰§è¡Œåˆ‡æ¢å‰é©±èŠ‚ç‚¹ç­‰å¾…çŠ¶æ€åè¿”å› falseï¼Œç»§ç»­è¿›è¡Œå¾ªç¯å°è¯•è·å–åŒæ­¥çŠ¶æ€

> è¿™ä¸€æ­¥æ“ä½œä¿è¯äº†çº¿ç¨‹èƒ½è¿›è¡Œå¤šæ¬¡é‡è¯•ï¼Œå°½é‡é¿å…çº¿ç¨‹çŠ¶æ€åˆ‡æ¢



å¦‚æœ T1 çº¿ç¨‹æ²¡æœ‰é‡Šæ”¾é”ï¼ŒT2 çº¿ç¨‹ç¬¬äºŒæ¬¡æ‰§è¡Œåˆ° shouldParkAfterFailedAcquire æ–¹æ³•ï¼Œå› ä¸ºå‰é©±èŠ‚ç‚¹å·²è®¾ç½®ä¸º SIGNALï¼Œæ‰€ä»¥ä¼šç›´æ¥è¿”å› trueï¼Œæ‰§è¡Œçº¿ç¨‹é˜»å¡æ“ä½œ

```java
private final boolean parkAndCheckInterrupt() {  	// å°†å½“å‰çº¿ç¨‹è¿›è¡Œé˜»å¡    LockSupport.park(this);  	// æ–¹æ³•è¿”å›äº†å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼Œå¹¶å°†å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è¯†è®¾ç½®ä¸ºfalse    return Thread.interrupted();}
```



LockSupport.park æ–¹æ³•å°†å½“å‰ç­‰å¾…é˜Ÿåˆ—ä¸­çº¿ç¨‹è¿›è¡Œé˜»å¡æ“ä½œï¼Œçº¿ç¨‹æ‰§è¡Œä¸€ä¸ªä» RUNNABLE åˆ° WAITING çŠ¶æ€è½¬å˜

å¦‚æœçº¿ç¨‹è¢«å”¤é†’ï¼Œé€šè¿‡æ‰§è¡Œ Thread.interrupted æŸ¥çœ‹ä¸­æ–­çŠ¶æ€ï¼Œè¿™é‡Œçš„ä¸­æ–­çŠ¶æ€ä¼šè¢«ä¼ é€’åˆ° acquire æ–¹æ³•

```java
public final void acquire(int arg) {    if (!tryAcquire(arg) &&            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))      	// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­, è¿™é‡Œä¼šå†æ¬¡è®¾ç½®ä¸­æ–­çŠ¶æ€      	// å› ä¸ºå¦‚æœçº¿ç¨‹ä¸­æ–­, è°ƒç”¨ Thread.interrupted è™½ç„¶ä¼šè¿”å› true, ä½†æ˜¯ä¼šæ¸…é™¤çº¿ç¨‹ä¸­æ–­çŠ¶æ€        selfInterrupt();}
```

å³ä½¿çº¿ç¨‹ä» park æ–¹æ³•ä¸­å”¤é†’åå‘ç°è‡ªå·±è¢«ä¸­æ–­äº†ï¼Œä½†æ˜¯ä¸å½±å“æ¥ä¸‹æ¥çš„è·å–é”æ“ä½œï¼Œå¦‚æœéœ€è¦è®¾ç½®çº¿ç¨‹ä¸­æ–­æ¥å½±å“æµç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ lockInterruptibly è·å¾—é”ï¼ŒæŠ›å‡ºæ£€æŸ¥å¼‚å¸¸ InterruptedException





### cancelAcquire

å–æ¶ˆæ’é˜Ÿæ–¹æ³•æ˜¯ AQS ä¸­æ¯”è¾ƒéš¾çš„çŸ¥è¯†ç‚¹ï¼Œä¸å®¹æ˜“è¢«ç†è§£

å½“çº¿ç¨‹å› ä¸ºè‡ªæ—‹æˆ–è€…å¼‚å¸¸ç­‰æƒ…å†µè·å–é”å¤±è´¥ï¼Œä¼šè°ƒç”¨æ­¤æ–¹æ³•è¿›è¡Œå–æ¶ˆæ­£åœ¨è·å–é”çš„æ“ä½œ

```java
private void cancelAcquire(Node node) {    // ä¸å­˜åœ¨çš„èŠ‚ç‚¹ç›´æ¥è¿”å›    if (node == null)        return;    node.thread = null;    /**     * waitStatus > 0 ä»£è¡¨èŠ‚ç‚¹ä¸ºå–æ¶ˆçŠ¶æ€     * whileå¾ªç¯ä¼šå°†nodeèŠ‚ç‚¹çš„å‰é©±æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªéå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹     * predç­‰äºå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼ˆéå–æ¶ˆçŠ¶æ€ï¼‰     */    Node pred = node.prev;    while (pred.waitStatus > 0)        node.prev = pred = pred.prev;    // è·å–è¿‡æ»¤åçš„å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹    Node predNext = pred.next;    // è®¾ç½®nodeç­‰å¾…çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€    node.waitStatus = Node.CANCELLED;    // ğŸš©æ­¥éª¤ä¸€ï¼Œå¦‚æœnodeæ˜¯å°¾èŠ‚ç‚¹ï¼Œä½¿ç”¨CASå°†predè®¾ç½®ä¸ºæ–°çš„å°¾èŠ‚ç‚¹  	    if (node == tail && compareAndSetTail(node, pred)) {      	// è®¾ç½®predï¼ˆæ–°tailï¼‰çš„åé©±æŒ‡é’ˆä¸ºç©º        compareAndSetNext(pred, predNext, null);    } else {        int ws;      	// ğŸš©æ­¥éª¤äºŒï¼Œnodeçš„å‰é©±èŠ‚ç‚¹predï¼ˆéå–æ¶ˆçŠ¶æ€ï¼‰!= å¤´èŠ‚ç‚¹        if (pred != head             	/**            	 * 1. predç­‰å¾…çŠ¶æ€ç­‰äºSIGNAL            	 * 2. ws <= 0å¹¶ä¸”è®¾ç½®predç­‰å¾…çŠ¶æ€ä¸ºSIGNAL            	 */            	&& ((ws = pred.waitStatus) == Node.SIGNAL || (ws <= 0 && compareAndSetWaitStatus(pred, ws, Node.SIGNAL)))             	// predä¸­çº¿ç¨‹ä¸ä¸ºç©º            	&& pred.thread != null) {            Node next = node.next;          	/**          	 * 1. å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ä¸ä¸ºç©º          	 * 2. åç»§èŠ‚ç‚¹ç­‰å¾…çŠ¶æ€<=0ï¼ˆè¡¨ç¤ºéå–æ¶ˆçŠ¶æ€ï¼‰          	 */            if (next != null && next.waitStatus <= 0)              	// è®¾ç½®predçš„åç»§èŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹                compareAndSetNext(pred, predNext, next);        } else {          	// ğŸš©æ­¥éª¤ä¸‰ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹æˆ–è€…ä¸Šè¿°æ¡ä»¶ä¸æ»¡è¶³, æ‰§è¡Œå”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹æµç¨‹            unparkSuccessor(node);        }        node.next = node; // help GC    }}
```



é€»è¾‘ç¨å¾®å¤æ‚ä¸€äº›ï¼Œæ¯”è¾ƒé‡è¦æ˜¯ä»¥ä¸‹ä¸‰ä¸ªé€»è¾‘

1. æ­¥éª¤ä¸€å½“å‰èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹çš„è¯ï¼Œè®¾ç½® pred èŠ‚ç‚¹ä¸ºæ–°çš„å°¾èŠ‚ç‚¹ï¼ŒæˆåŠŸè®¾ç½®åå†å°† pred åç»§èŠ‚ç‚¹è®¾ç½®ä¸ºç©ºï¼ˆå°¾èŠ‚ç‚¹ä¸ä¼šæœ‰åç»§èŠ‚ç‚¹ï¼‰

2. æ­¥éª¤äºŒéœ€è¦æ»¡è¶³ä»¥ä¸‹å››ä¸ªæ¡ä»¶æ‰ä¼šå°†å‰é©±èŠ‚ç‚¹ï¼ˆéå–æ¶ˆçŠ¶æ€ï¼‰çš„åç»§æŒ‡é’ˆæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„åç»§æŒ‡é’ˆ

   1ï¼‰å½“å‰èŠ‚ç‚¹ä¸ç­‰äºå°¾èŠ‚ç‚¹

   2ï¼‰å½“å‰èŠ‚ç‚¹å‰é©±èŠ‚ç‚¹ä¸ç­‰äºå¤´èŠ‚ç‚¹

   3ï¼‰å‰é©±èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€ä¸ä¸ºå–æ¶ˆçŠ¶æ€

   4ï¼‰å‰é©±èŠ‚ç‚¹çš„æ‹¥æœ‰çº¿ç¨‹ä¸ä¸ºç©º

3. å¦‚æœä¸æ»¡è¶³æ­¥éª¤äºŒçš„è¯ï¼Œä¼šæ‰§è¡Œæ­¥éª¤ä¸‰ç›¸å…³é€»è¾‘ï¼Œå”¤é†’åç»§èŠ‚ç‚¹







**æ­¥éª¤ä¸€ï¼š**

å‡è®¾å½“å‰å–æ¶ˆèŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹å¹¶ä¸”å‰ç½®èŠ‚ç‚¹æ— å–æ¶ˆèŠ‚ç‚¹ï¼Œç°æœ‰ç­‰å¾…é˜Ÿåˆ—å¦‚ä¸‹å›¾ï¼Œæ‰§è¡Œä¸‹è¿°é€»è¾‘

```java
if (node == tail && compareAndSetTail(node, pred)) {    compareAndSetNext(pred, predNext, null);}
```

![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201112180208027.png)

å°† pred è®¾ç½®ä¸ºæ–°çš„å°¾èŠ‚ç‚¹ï¼Œå¹¶å°† pred åç»§èŠ‚ç‚¹è®¾ç½®ä¸ºç©ºï¼Œå› ä¸ºå°¾èŠ‚ç‚¹ä¸ä¼šæœ‰åç»§èŠ‚ç‚¹äº†

T4 çº¿ç¨‹æ‰€åœ¨èŠ‚ç‚¹å› æ— å¼•ç”¨æŒ‡å‘ï¼Œä¼šè¢« GC åƒåœ¾å›æ”¶å¤„ç†

![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201114141417895.png)

**æ­¥éª¤äºŒï¼š**

å¦‚æœå½“å‰éœ€è¦å–æ¶ˆèŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸ºå–æ¶ˆçŠ¶æ€èŠ‚ç‚¹ï¼Œå¦‚å›¾æ‰€ç¤º

![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201114140258406.png)

è®¾ç½® predï¼ˆéå–æ¶ˆçŠ¶æ€ï¼‰çš„åç»§èŠ‚ç‚¹ä¸º node çš„åç»§èŠ‚ç‚¹ï¼Œå¹¶è®¾ç½® node çš„ next ä¸º è‡ªå·±æœ¬èº«

![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201114141329010.png)

**çº¿ç¨‹T2ã€T3æ‰€åœ¨èŠ‚ç‚¹å› ä¸ºè¢«T4æ‰€ç›´æ¥æˆ–é—´æ¥æŒ‡å‘ï¼Œå¦‚ä½•è¿›è¡ŒGC?**

AQS ç­‰å¾…é˜Ÿåˆ—ä¸­å–æ¶ˆçŠ¶æ€èŠ‚ç‚¹ä¼šåœ¨ shouldParkAfterFailedAcquire æ–¹æ³•ä¸­è¢« GC åƒåœ¾å›æ”¶

```java
if (ws > 0) {    do {        node.prev = pred = pred.prev;    } while (pred.waitStatus > 0);    pred.next = node;}
```



T4 çº¿ç¨‹æ‰€åœ¨èŠ‚ç‚¹è·å–é”å¤±è´¥å°è¯•åœæ­¢æ—¶ï¼Œä¼šæ‰§è¡Œä¸Šè¿°ä»£ç ï¼Œæ‰§è¡Œåçš„ç­‰å¾…é˜Ÿåˆ—å¦‚ä¸‹å›¾æ‰€ç¤º

![](https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201114144243192.png)

ç­‰å¾…é˜Ÿåˆ—ä¸­å–æ¶ˆçŠ¶æ€èŠ‚ç‚¹å°±å¯ä»¥è¢« GC åƒåœ¾å›æ”¶äº†ï¼Œè‡³æ­¤åŠ é”æµç¨‹ä¹Ÿå°±ç»“æŸäº†ï¼Œä¸‹é¢ç»§ç»­çœ‹å¦‚ä½•è§£é”



## ç‹¬å è§£é”æºç è§£æ

è§£é”æµç¨‹ç›¸å¯¹äºåŠ é”ç®€å•äº†å¾ˆå¤šï¼Œè°ƒç”¨å¯¹åº”API-lock.unlock()

```java
--- ReentrantLockpublic void unlock() {    sync.release(1);}--- AQSpublic final boolean release(int arg) {  	// å°è¯•é‡Šæ”¾é”    if (tryRelease(arg)) {        Node h = head;        if (h != null && h.waitStatus != 0)            unparkSuccessor(h);        return true;    }    return false;}
```



### é‡Šæ”¾é”åŒæ­¥çŠ¶æ€

tryRelease æ˜¯å®šä¹‰åœ¨ AQS ä¸­çš„æŠ½è±¡æ–¹æ³•ï¼Œé€šè¿‡ Sync ç±»é‡å†™äº†å…¶å®ç°

```java
protected final boolean tryRelease(int releases) {    int c = getState() - releases;  	// å¦‚æœå½“å‰çº¿ç¨‹ä¸ç­‰äºæ‹¥æœ‰é”çº¿ç¨‹, æŠ›å‡ºå¼‚å¸¸    if (Thread.currentThread() != getExclusiveOwnerThread())        throw new IllegalMonitorStateException();    boolean free = false;    if (c == 0) {        free = true;      	// å°†æ‹¥æœ‰é”çº¿ç¨‹è®¾ç½®ä¸ºç©º        setExclusiveOwnerThread(null);    }  	// è®¾ç½®StateçŠ¶æ€ä¸º0, è§£é”æˆåŠŸ    setState(c);    return free;}
```



### å”¤é†’åç»§èŠ‚ç‚¹

æ­¤æ—¶ State å€¼å·²è¢«é‡Šæ”¾ï¼Œå¯¹äºå¤´èŠ‚ç‚¹çš„åˆ¤æ–­è¿™å—æµç¨‹æ¯”è¾ƒæœ‰æ„æ€

```java
Node h = head;if (h != null && h.waitStatus != 0)		unparkSuccessor(h);
```



**ä»€ä¹ˆæƒ…å†µä¸‹å¤´èŠ‚ç‚¹ä¸ºç©º**ï¼Œå½“çº¿ç¨‹è¿˜åœ¨äº‰å¤ºé”ï¼Œé˜Ÿåˆ—è¿˜æœªåˆå§‹åŒ–ï¼Œå¤´èŠ‚ç‚¹å¿…ç„¶æ˜¯ä¸ºç©ºçš„

å½“å¤´èŠ‚ç‚¹ç­‰å¾…çŠ¶æ€ç­‰äº0ï¼Œè¯æ˜åç»§èŠ‚ç‚¹è¿˜åœ¨è‡ªæ—‹ï¼Œä¸éœ€è¦è¿›è¡Œåç»§èŠ‚ç‚¹å”¤é†’



å¦‚æœåŒæ—¶æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œä¼šå¯¹ç­‰å¾…é˜Ÿåˆ—å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹è¿›è¡Œå”¤é†’æ“ä½œ

```java
private void unparkSuccessor(Node node) {  	// è·å–nodeç­‰å¾…çŠ¶æ€    int ws = node.waitStatus;    if (ws < 0)        compareAndSetWaitStatus(node, ws, 0);  	// è·å–nodeçš„åç»§èŠ‚ç‚¹    Node s = node.next;  	// å¦‚æœä¸‹ä¸ªèŠ‚ç‚¹ä¸ºç©ºæˆ–è€…è¢«å–æ¶ˆ, éå†é˜Ÿåˆ—æŸ¥è¯¢éå–æ¶ˆèŠ‚ç‚¹    if (s == null || s.waitStatus > 0) {        s = null;      	// ä»é˜Ÿå°¾å¼€å§‹æŸ¥æ‰¾, ç­‰å¾…çŠ¶æ€ <= 0 çš„èŠ‚ç‚¹        for (Node t = tail; t != null && t != node; t = t.prev)            if (t.waitStatus <= 0)                s = t;    }  	// æ»¡è¶³ s != null && s.waitStatus <= 0  	// æ‰§è¡Œ unpark    if (s != null)        LockSupport.unpark(s.thread);}
```



**ä¸ºä»€ä¹ˆæŸ¥æ‰¾é˜Ÿåˆ—ä¸­æœªè¢«å–æ¶ˆçš„èŠ‚ç‚¹éœ€è¦ä»å°¾éƒ¨å¼€å§‹ï¼Ÿ**

è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ä¸ªåŸå› å¯ä»¥è§£é‡Šï¼Œåˆ†åˆ«æ˜¯ Node å…¥é˜Ÿå’Œæ¸…ç†å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹

1. å…ˆä» addWaiter å…¥é˜Ÿæ—¶è¯´èµ·ï¼ŒcompareAndSetTail(pred, node)ã€pred.next = node å¹¶éåŸå­æ“ä½œï¼Œå¦‚æœåœ¨æ‰§è¡Œ pred.next = node å‰è¿›è¡Œ unparkSuccessorï¼Œå°±æ²¡æœ‰åŠæ³•é€šè¿‡ next æŒ‡é’ˆå‘åéå†ï¼Œæ‰€ä»¥æ‰ä¼šä»åå‘å‰æ‰¾å¯»éå–æ¶ˆçš„èŠ‚ç‚¹

2. cancelAcquire æ–¹æ³•ä¹Ÿæœ‰å¯¼è‡´ä½¿ç”¨ head æ— æ³•éå†å…¨éƒ¨ Node çš„å› ç´ ï¼Œå› ä¸ºå…ˆæ–­å¼€çš„æ˜¯ next æŒ‡é’ˆï¼Œprev æŒ‡é’ˆå¹¶æœªæ–­å¼€



### å”¤é†’é˜»å¡åæµç¨‹

å½“çº¿ç¨‹è·å–é”å¤±è´¥è¢« park åè¿›å…¥äº†é˜»å¡æ¨¡å¼ï¼Œå‰é©±èŠ‚ç‚¹é‡Šæ”¾é”åä¼šè¿›è¡Œå”¤é†’ unparkï¼Œè¢«é˜»å¡çº¿ç¨‹çŠ¶æ€å›å½’ RUNNABLE çŠ¶æ€

```java
private final boolean parkAndCheckInterrupt() {  	// ä»æ­¤ä½ç½®å”¤é†’    LockSupport.park(this);    return Thread.interrupted();}
```



è¢«å”¤é†’çº¿ç¨‹æ£€æŸ¥è‡ªèº«æ˜¯å¦è¢«ä¸­æ–­ï¼Œè¿”å›è‡ªèº«ä¸­æ–­çŠ¶æ€åˆ° acquireQueued

```java
final boolean acquireQueued(final Node node, int arg) {    boolean failed = true;    try {        boolean interrupted = false;        for (; ; ) {            final Node p = node.predecessor();            if (p == head && tryAcquire(arg)) {                setHead(node);                p.next = null; // help GC                failed = false;                return interrupted;            }            if (shouldParkAfterFailedAcquire(p, node) &&                    parkAndCheckInterrupt())                interrupted = true;        }    } finally {        if (failed)            cancelAcquire(node);    }}
```



å‡è®¾è‡ªèº«è¢«ä¸­æ–­ï¼Œè®¾ç½® interrupted = trueï¼Œç»§ç»­é€šè¿‡å¾ªç¯å°è¯•è·å–é”ï¼Œè·å–é”æˆåŠŸåè¿”å› interrupted ä¸­æ–­çŠ¶æ€

**ä¸­æ–­çŠ¶æ€æœ¬èº«å¹¶ä¸ä¼šå¯¹åŠ é”æµç¨‹äº§ç”Ÿå½±å“**ï¼Œè¢«å”¤é†’åè¿˜æ˜¯ä¼šä¸æ–­è¿›è¡Œè·å–é”ï¼Œç›´åˆ°è·å–é”æˆåŠŸè¿›è¡Œè¿”å›ï¼Œè¿”å›ä¸­æ–­çŠ¶æ€æ˜¯ä¸ºäº†åç»­è¡¥å……ä¸­æ–­çºªå½•



å¦‚æœçº¿ç¨‹è¢«å”¤é†’åå‘ç°ä¸­æ–­ï¼ŒæˆåŠŸè·å–é”åä¼šå°†ä¸­æ–­çŠ¶æ€è¿”å›ï¼Œè¡¥å……ä¸­æ–­çŠ¶æ€

```java
public final void acquire(int arg) {    if (!tryAcquire(arg) &&            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))        selfInterrupt();}
```



selfInterrupt å°±æ˜¯å¯¹çº¿ç¨‹ä¸­æ–­çŠ¶æ€çš„ä¸€ä¸ªè¡¥å……ï¼Œè¡¥å……çŠ¶æ€æˆåŠŸåï¼Œæµç¨‹ç»“æŸ

```java
static void selfInterrupt() {    Thread.currentThread().interrupt();}
```



## é˜…è¯»æºç å°æŠ€å·§

**1ã€ä»å…¨å±€æŒæ¡è¦é˜…è¯»çš„æºç æä¾›äº†ä»€ä¹ˆåŠŸèƒ½**

è¿™ä¹Ÿæ˜¯æˆ‘ä¸€ç›´æ¨å´‡çš„å­¦ä¹ æºç æ–¹å¼ï¼Œå­¦ä¹ æºç çš„å…³é”®ç‚¹æ˜¯æŠ“ä½ä¸»çº¿æµç¨‹ï¼Œåœ¨äº†è§£ä¸»çº¿ä¹‹å‰ä¸è¦æœ€å¼€å§‹å°±ç ”ç©¶åˆ°æºç å®ç°ç»†èŠ‚ä¸­ï¼Œå¦åˆ™å¾ˆå®¹æ˜“è¿·å¤±åœ¨ç»†ææœ«èŠ‚çš„ä»£ç ä¸­

ä»¥æ–‡ç« ä¸­çš„ AQS ä¸¾ä¾‹ï¼Œå½“ä½ çŸ¥é“äº†å®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œä½¿ç”¨å®ƒå¯ä»¥æ›´ç®€å•çš„æ„é€ é”å’ŒåŒæ­¥å™¨ç­‰å®ç°

ç„¶åä»ä¸­ç†è§£ tryAcquireã€tryRelease ç­‰æ–¹æ³•å®ç°ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å¯ä»¥æ›´å¥½çš„ç†è§£ä¸ AQS ä¸å…¶å­ç±»ç›¸å…³çš„ä»£ç 



**2ã€æŠŠä¸æ˜“ç†è§£çš„æºç ç²˜è´´å‡ºæ¥ï¼Œæ•´ç†å¥½æ ¼å¼æ‰“å¥½å¤‡æ³¨**

ä¸€èˆ¬æºç ä¸­çš„è¡Œä¸ºæ ¼å¼å’Œæˆ‘ä»¬æ—¥å¸¸æ•²ä»£ç æ˜¯ä¸ä¸€æ ·çš„ï¼Œè€Œä¸” JDK æºç ä¸­çš„å˜é‡å‘½åå®åœ¨æ˜¯æƒ¨ä¸å¿ç¹

æ‰€ä»¥å°±åº”è¯¥å°†éš¾ä»¥ç†è§£çš„æºç ç²˜è´´å‡ºï¼Œæ ‡ä¸Šå¯¹åº”æ³¨é‡Šä»¥åŠè°ƒæ•´æˆæ˜“ç†è§£çš„æ ¼å¼ï¼Œè¿™æ ·å¯¹äºæºç çš„é˜…è¯»å°±ä¼šè½»æ¾å¾ˆå¤š



## åè®°

å¹³å¸¸å·¥ä½œä¸­æ¥è§¦åˆ° AQS ç›¸å…³çŸ¥è¯†è¿˜æ˜¯å¾ˆå¤šçš„ï¼ŒçŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œæ–‡ç« ä»¥ ReentrantLock ä½œä¸ºåˆ‡å…¥ç‚¹ï¼Œè®²è¿°äº†å…¶å…¬å¹³é”å’Œéå…¬å¹³é”çš„æ¦‚å¿µï¼Œä»¥åŠå¯¹åº” AQS ä¸­ CLHã€AOS ç­‰ä¸å®¹æ˜“è¢«å‘ç°çš„æ¦‚å¿µ

é’ˆå¯¹ ReentrantLock ä»¥åŠ AQS åŠ é”ã€è§£é”ã€æ’é˜Ÿç­‰æµç¨‹è¿›è¡Œäº†è¯¦ç»†è¯´æ˜ï¼Œä»¥å›¾æ–‡å¹¶èŒ‚çš„æ–¹å¼è®²è¿°äº†å…¶æµç¨‹æºç å®ç°ç»†èŠ‚ï¼Œè¿™é‡Œå¸Œæœ›åœ¨çœ‹çš„å°ä¼™ä¼´éƒ½èƒ½æ”¶è· AQS ç›¸å…³çŸ¥è¯†



**ç”±äºä½œè€…æ°´å¹³æœ‰é™, æ¬¢è¿å¤§å®¶èƒ½å¤Ÿåé¦ˆæŒ‡æ­£æ–‡ç« ä¸­é”™è¯¯ä¸æ­£ç¡®çš„åœ°æ–¹, æ„Ÿè°¢ ğŸ™**

å°ä¼™ä¼´çš„å–œæ¬¢å°±æ˜¯å¯¹æˆ‘æœ€å¤§çš„æ”¯æŒ, å¦‚æœè¯»äº†æ–‡ç« æœ‰æ‰€æ”¶è·, å¸Œæœ›èƒ½å¤Ÿ **ç‚¹èµã€è¯„è®ºã€å…³æ³¨ä¸‰è¿!**



å‚è€ƒèµ„æ–™

- https://tech.meituan.com/2019/12/05/aqs-theory-and-apply.html
- https://tech.meituan.com/2018/11/15/java-lock.html
- https://mp.weixin.qq.com/s/y_e3ciU-hiqlb5vseuOFyw
- https://zhuanlan.zhihu.com/p/197840259?utm_source=wechat_session
- https://blog.csdn.net/java_lyvee/article/details/98966684
- https://zhuanlan.zhihu.com/p/197840259?utm_source=wechat_session

